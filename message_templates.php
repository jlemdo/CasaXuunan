<?php
// message_templates.php - Plantillas de mensajes para WhatsApp

// ===== PLANTILLAS DE MENSAJES =====

function generateNewReservationMessage($reservation) {
    $check_in_formatted = date('d/M/Y', strtotime($reservation['check_in']));
    $check_out_formatted = date('d/M/Y', strtotime($reservation['check_out']));
    
    $message = "üéâ *NUEVA RESERVA*\n\n";
    $message .= "üë§ *Hu√©sped:* {$reservation['guest_name']}\n";
    $message .= "üè† *Habitaci√≥n:* {$reservation['property_name']}\n";
    $message .= "üìÖ *Check-in:* {$check_in_formatted}\n";
    $message .= "üìÖ *Check-out:* {$check_out_formatted}\n";
    $message .= "üë• *Hu√©spedes:* {$reservation['guests']}\n";
    $message .= "üí∞ *Total:* $" . number_format($reservation['total'], 2) . " {$reservation['currency']}\n";
    $message .= "üì± *Canal:* {$reservation['channel']}\n\n";
    $message .= "üÜî *ID:* {$reservation['id']}";
    
    return $message;
}

function generateCancelledReservationMessage($reservation) {
    $check_in_formatted = date('d/M/Y', strtotime($reservation['check_in']));
    $check_out_formatted = date('d/M/Y', strtotime($reservation['check_out']));
    
    $message = "‚ùå *RESERVA CANCELADA*\n\n";
    $message .= "üë§ *Hu√©sped:* {$reservation['guest_name']}\n";
    $message .= "üè† *Habitaci√≥n:* {$reservation['property_name']}\n";
    $message .= "üìÖ *Fechas:* {$check_in_formatted} - {$check_out_formatted}\n";
    $message .= "üìù *Motivo:* {$reservation['cancellation_reason']}\n\n";
    $message .= "üîÑ *Acci√≥n:* Fechas liberadas para nuevas reservas\n";
    $message .= "üÜî *ID:* {$reservation['id']}";
    
    return $message;
}

function generateModifiedReservationMessage($reservation) {
    $message = "üìù *RESERVA MODIFICADA*\n\n";
    $message .= "üë§ *Hu√©sped:* {$reservation['guest_name']}\n";
    $message .= "üè† *Habitaci√≥n:* {$reservation['property_name']}\n\n";
    $message .= "üîÑ *Cambios realizados:*\n";
    
    // Procesar cambios espec√≠ficos
    if (!empty($reservation['changes'])) {
        foreach ($reservation['changes'] as $change) {
            $message .= "‚Ä¢ " . formatChange($change) . "\n";
        }
    } else {
        $message .= "‚Ä¢ Detalles de la reserva actualizados\n";
    }
    
    $message .= "\nüÜî *ID:* {$reservation['id']}";
    
    return $message;
}

function generateConfirmedReservationMessage($reservation) {
    $check_in_formatted = date('d/M/Y', strtotime($reservation['check_in']));
    $check_out_formatted = date('d/M/Y', strtotime($reservation['check_out']));
    
    $message = "‚úÖ *RESERVA CONFIRMADA*\n\n";
    $message .= "üë§ *Hu√©sped:* {$reservation['guest_name']}\n";
    $message .= "üè† *Habitaci√≥n:* {$reservation['property_name']}\n";
    $message .= "üìÖ *Check-in:* {$check_in_formatted}\n";
    $message .= "üìÖ *Check-out:* {$check_out_formatted}\n\n";
    $message .= "üéØ *Estado:* Pendiente ‚Üí Confirmada ‚úÖ\n";
    $message .= "üÜî *ID:* {$reservation['id']}";
    
    return $message;
}

function generateNewMessageAlert($message_data) {
    $message = "üí¨ *NUEVO MENSAJE*\n\n";
    $message .= "üë§ *De:* {$message_data['guest_name']}\n";
    $message .= "üè† *Habitaci√≥n:* {$message_data['property_name']}\n";
    $message .= "üì± *Canal:* {$message_data['channel']}\n";
    $message .= "‚è∞ *Recibido:* {$message_data['received_at']}\n\n";
    $message .= "üí≠ *Mensaje:*\n\"{$message_data['message_content']}\"\n\n";
    $message .= "üì≤ *Responder en la plataforma correspondiente*";
    
    return $message;
}

function generateNewReviewAlert($review_data) {
    $stars = str_repeat('‚≠ê', $review_data['rating']);
    
    $message = "‚≠ê *NUEVA RESE√ëA*\n\n";
    $message .= "üë§ *Cliente:* {$review_data['guest_name']}\n";
    $message .= "üè† *Habitaci√≥n:* {$review_data['property_name']}\n";
    $message .= "‚≠ê *Calificaci√≥n:* {$stars} ({$review_data['rating']}/5)\n";
    $message .= "üì± *Plataforma:* {$review_data['platform']}\n\n";
    $message .= "üí≠ *Comentario:*\n\"{$review_data['comment']}";
    
    if (strlen($review_data['comment']) >= 100) {
        $message .= "...\"";
    } else {
        $message .= "\"";
    }
    
    return $message;
}

function generateCheckinReminder($reservation) {
    $check_in_date = date('d/M/Y', strtotime($reservation['check_in']));
    $check_in_time = date('H:i', strtotime($reservation['check_in']));
    
    $message = "üîî *RECORDATORIO CHECK-IN*\n\n";
    $message .= "üë§ *Hu√©sped:* {$reservation['guest_name']}\n";
    $message .= "üè† *Habitaci√≥n:* {$reservation['property_name']}\n";
    $message .= "üìÖ *Check-in:* {$check_in_date} a las {$check_in_time}\n";
    
    if (isset($reservation['guest_phone'])) {
        $message .= "üì± *Contacto:* {$reservation['guest_phone']}\n";
    }
    
    $message .= "\nüè† *Preparar habitaci√≥n*\n";
    $message .= "üßπ *Verificar limpieza final*\n";
    $message .= "üÜî *ID:* {$reservation['id']}";
    
    return $message;
}

function generateCheckoutReminder($reservation) {
    $checkout_date = date('d/M/Y', strtotime($reservation['check_out']));
    $checkout_time = date('H:i', strtotime($reservation['check_out']));
    
    $message = "üö™ *CHECK-OUT HOY*\n\n";
    $message .= "üë§ *Hu√©sped:* {$reservation['guest_name']}\n";
    $message .= "üè† *Habitaci√≥n:* {$reservation['property_name']}\n";
    $message .= "üìÖ *Check-out:* {$checkout_date} a las {$checkout_time}\n\n";
    $message .= "üìã *Tareas post-salida:*\n";
    $message .= "üßπ Programar limpieza\n";
    $message .= "üîç Inspecci√≥n de habitaci√≥n\n";
    $message .= "üì∏ Reporte de estado\n\n";
    $message .= "üÜî *ID:* {$reservation['id']}";
    
    return $message;
}

function generateDailySummaryMessage($stats) {
    $today = date('d/M/Y');
    
    $message = "üìä *RESUMEN DIARIO*\n";
    $message .= "üìÖ {$today}\n\n";
    $message .= "üéâ *Nuevas reservas:* {$stats['new_reservations']}\n";
    $message .= "üí∞ *Ingresos generados:* $" . number_format($stats['total_revenue'], 2) . " MXN\n";
    $message .= "üë• *Check-ins hoy:* {$stats['checkins_today']}\n";
    $message .= "üö™ *Check-outs hoy:* {$stats['checkouts_today']}\n";
    
    if ($stats['new_reviews'] > 0) {
        $message .= "‚≠ê *Rese√±as nuevas:* {$stats['new_reviews']}\n";
    }
    
    if ($stats['occupancy_rate'] > 0) {
        $message .= "üìà *Ocupaci√≥n:* {$stats['occupancy_rate']}%\n";
    }
    
    $message .= "\nüè† *Casa Xu'unan*";
    
    return $message;
}

function generateOccupancyAlert($occupancy_data) {
    $weekend_dates = $occupancy_data['weekend_dates'];
    $occupancy_rate = $occupancy_data['occupancy_rate'];
    $available_rooms = $occupancy_data['available_rooms'];
    $potential_revenue = $occupancy_data['potential_revenue'];
    
    $message = "üìà *ALERTA DE OCUPACI√ìN*\n\n";
    $message .= "üìÖ *Fin de semana:* {$weekend_dates}\n";
    $message .= "üè† *Ocupaci√≥n:* {$occupancy_rate}% ({$occupancy_data['occupied_rooms']}/{$occupancy_data['total_rooms']} habitaciones)\n\n";
    
    if ($available_rooms > 0) {
        $message .= "üí° *Oportunidad:*\n";
        $message .= "üîì Habitaciones disponibles: {$available_rooms}\n";
        $message .= "üí∞ Ingresos potenciales: $" . number_format($potential_revenue, 2) . "\n";
    } else {
        $message .= "üéâ *¬°COMPLETAMENTE OCUPADO!*\n";
        $message .= "‚úÖ Todas las habitaciones reservadas\n";
    }
    
    return $message;
}

function generateProblemAlert($problem_data) {
    $message = "‚ö†Ô∏è *PROBLEMA DETECTADO*\n\n";
    $message .= "üë§ *Hu√©sped:* {$problem_data['guest_name']}\n";
    $message .= "üè† *Habitaci√≥n:* {$problem_data['property_name']}\n";
    $message .= "üö® *Tipo:* {$problem_data['problem_type']}\n";
    
    if (isset($problem_data['expected_time'])) {
        $message .= "üìÖ *Programado:* {$problem_data['expected_time']}\n";
    }
    
    $message .= "‚è∞ *Detectado:* " . date('d/M/Y H:i') . "\n\n";
    $message .= "üîç *Requiere atenci√≥n inmediata*\n";
    $message .= "üÜî *ID:* {$problem_data['reservation_id']}";
    
    return $message;
}

// ===== FUNCIONES AUXILIARES =====

function formatChange($change) {
    switch ($change['type']) {
        case 'check_in_date':
            return "üìÖ Check-in: {$change['old_value']} ‚Üí {$change['new_value']}";
        case 'check_out_date':
            return "üìÖ Check-out: {$change['old_value']} ‚Üí {$change['new_value']}";
        case 'guest_count':
            return "üë• Hu√©spedes: {$change['old_value']} ‚Üí {$change['new_value']}";
        case 'total_amount':
            return "üí∞ Total: $" . number_format($change['old_value'], 2) . " ‚Üí $" . number_format($change['new_value'], 2);
        default:
            return "{$change['field']}: {$change['old_value']} ‚Üí {$change['new_value']}";
    }
}

function getMessageTemplate($template_name, $variables = []) {
    $templates = [
        'welcome' => "¬°Bienvenido a Casa Xu'unan! Tu reserva est√° confirmada.",
        'reminder_checkin' => "Recordatorio: Tu check-in es ma√±ana a las {{time}}",
        'thank_you' => "Gracias por tu estad√≠a en Casa Xu'unan. ¬°Esperamos verte pronto!"
    ];
    
    if (!isset($templates[$template_name])) {
        return null;
    }
    
    $message = $templates[$template_name];
    
    // Reemplazar variables
    foreach ($variables as $key => $value) {
        $message = str_replace('{{' . $key . '}}', $value, $message);
    }
    
    return $message;
}

// Funci√≥n para personalizar mensajes seg√∫n el contacto
function customizeMessageForContact($message, $contact_type) {
    switch ($contact_type) {
        case 'limpieza':
            // Agregar informaci√≥n espec√≠fica para limpieza
            if (strpos($message, 'CHECK-IN') !== false || strpos($message, 'CHECK-OUT') !== false) {
                $message .= "\n\nüßπ *Acci√≥n requerida para limpieza*";
            }
            break;
            
        case 'recepcion':
            // Agregar informaci√≥n espec√≠fica para recepci√≥n
            if (strpos($message, 'MENSAJE') !== false) {
                $message .= "\n\nüìû *Responder al hu√©sped*";
            }
            break;
            
        case 'manager':
            // Mantener mensaje completo para manager
            break;
    }
    
    return $message;
}

?>